AWSTemplateFormatVersion: "2010-09-09"
Conditions:
    CreateVpcResources:
        Fn::Equals:
            - Ref: ExistingVpcId
            - ""
    EnableDockerPullThroughCache:
        Fn::And:
            - Fn::Equals:
                - Ref: EnablePullThroughCache
                - "true"
            - Fn::Not:
                - Fn::Equals:
                    - Ref: DockerHubUsername
                    - ""
            - Fn::Not:
                - Fn::Equals:
                    - Ref: DockerHubAccessToken
                    - ""
    EnablePullThroughCache:
        Fn::Equals:
            - Ref: EnablePullThroughCache
            - "true"
    OidcClaims:
        Fn::Not:
            - Fn::Equals:
                - Fn::Join:
                    - ""
                    - Ref: OidcProviderClaims
                - ""
    OidcProvider:
        Fn::And:
            - Fn::Not:
                - Fn::Equals:
                    - Ref: OidcProviderIssuer
                    - ""
            - Fn::Not:
                - Fn::Equals:
                    - Fn::Join:
                        - ""
                        - Ref: OidcProviderSubjects
                    - ""
    OidcThumbprints:
        Fn::Not:
            - Fn::Equals:
                - Fn::Join:
                    - ""
                    - Ref: OidcProviderThumbprints
                - ""
    OverrideCIRoleName:
        Fn::Not:
            - Fn::Equals:
                - Ref: CIRoleName
                - ""
    RetainS3Bucket:
        Fn::Equals:
            - Ref: RetainBucket
            - "true"
Description: 'Defang AWS CloudFormation template for the CD task. Do not delete this stack in the AWS console: use the Defang CLI instead. To create this stack, scroll down to acknowledge the risks and press ''Create stack''.'
Metadata:
    AWS::CloudFormation::Interface:
        ParameterGroups:
            - Label:
                default: CI/CD Integration (OIDC)
              Parameters:
                - OidcProviderIssuer
                - OidcProviderSubjects
                - OidcProviderAudiences
                - CIRoleName
                - OidcProviderThumbprints
                - OidcProviderClaims
            - Label:
                default: Network Configuration
              Parameters:
                - ExistingVpcId
            - Label:
                default: Container Registry (ECR Pull-Through Cache)
              Parameters:
                - EnablePullThroughCache
                - DockerHubUsername
                - DockerHubAccessToken
            - Label:
                default: Storage Configuration
              Parameters:
                - RetainBucket
        ParameterLabels:
            CIRoleName:
                default: CI Role Name
            DockerHubAccessToken:
                default: Docker Hub Access Token
            DockerHubUsername:
                default: Docker Hub Username
            EnablePullThroughCache:
                default: Enable ECR Pull-Through Cache
            ExistingVpcId:
                default: Existing VPC ID
            OidcProviderAudiences:
                default: OIDC Trusted Audiences
            OidcProviderClaims:
                default: Additional OIDC Claim Conditions
            OidcProviderIssuer:
                default: OIDC Provider Issuer URL
            OidcProviderSubjects:
                default: OIDC Trusted Subject Patterns
            OidcProviderThumbprints:
                default: OIDC Provider Thumbprints
            RetainBucket:
                default: Retain S3 Bucket on Delete
Outputs:
    bucketName:
        Description: Name of the S3 bucket
        Value:
            Ref: Bucket
    ciRoleArn:
        Condition: OidcProvider
        Description: ARN of the CI role
        Value:
            Fn::GetAtt:
                - CIRole
                - Arn
    clusterName:
        Description: Name of the ECS cluster
        Value:
            Ref: Cluster
    defaultSecurityGroupId:
        Condition: CreateVpcResources
        Description: ID of the default security group
        Value:
            Fn::GetAtt:
                - VPC
                - DefaultSecurityGroup
    logGroupArn:
        Description: ARN of the CloudWatch log group
        Value:
            Fn::GetAtt:
                - LogGroup
                - Arn
    securityGroupId:
        Description: ID of the security group
        Value:
            Ref: SecurityGroup
    subnetId:
        Condition: CreateVpcResources
        Description: ID of the subnet
        Value:
            Ref: Subnet
    taskDefArn:
        Description: ARN of the ECS task definition
        Value:
            Ref: TaskDefinition
    templateVersion:
        Description: Version of this CloudFormation template
        Value: 3
Parameters:
    CIRoleName:
        Default: ""
        Description: Name of the CI role (optional)
        Type: String
    DockerHubAccessToken:
        Default: ""
        Description: Docker Hub access token for private registry access (optional)
        NoEcho: true
        Type: String
    DockerHubUsername:
        Default: ""
        Description: Docker Hub username for private registry access (optional)
        Type: String
    EnablePullThroughCache:
        AllowedValues:
            - "true"
            - "false"
        Default: "true"
        Description: Whether to enable ECR pull-through cache
        Type: String
    ExistingVpcId:
        Default: ""
        Description: 'ID of existing VPC to use (optional: leave empty to create new VPC)'
        Type: String
    OidcProviderAudiences:
        Default: sts.amazonaws.com
        Description: OIDC provider trusted audience(s) (optional)
        Type: CommaDelimitedList
    OidcProviderClaims:
        Default: ""
        Description: Additional OIDC claim conditions as comma-separated JSON "key":"value" pairs (optional)
        Type: CommaDelimitedList
    OidcProviderIssuer:
        Default: ""
        Description: OIDC provider trusted issuer (optional)
        Type: String
    OidcProviderSubjects:
        Default: ""
        Description: OIDC provider trusted subject pattern(s) (optional)
        Type: CommaDelimitedList
    OidcProviderThumbprints:
        Default: ""
        Description: OIDC provider thumbprint(s) (optional)
        Type: CommaDelimitedList
    RetainBucket:
        AllowedValues:
            - "true"
            - "false"
        Default: "true"
        Description: Whether to retain the S3 bucket on stack deletion
        Type: String
Resources:
    Bucket:
        DeletionPolicy:
            Fn::If:
                - RetainS3Bucket
                - RetainExceptOnCreate
                - Delete
        Properties:
            Tags:
                - Key: defang:CreatedBy
                  Value: defang
                - Key: defang:Prefix
                  Value: test
                - Key: defang:ManagedBy
                  Value: CloudFormation
                - Key: defang:CloudFormationStackName
                  Value:
                    Ref: AWS::StackName
                - Key: defang:CloudFormationStackRegion
                  Value:
                    Ref: AWS::Region
            VersioningConfiguration:
                Status: Enabled
        Type: AWS::S3::Bucket
    CIRole:
        Condition: OidcProvider
        Properties:
            AssumeRolePolicyDocument:
                Fn::Sub:
                    - |-
                      {
                          "Version": "2012-10-17",
                          "Statement": [{
                              "Effect": "Allow",
                              "Principal": {
                                  "Federated": "${Provider}"
                              },
                              "Action": "sts:AssumeRoleWithWebIdentity",
                              "Condition": {
                                  "StringEquals": {
                                      "${OidcProviderIssuer}:aud": [ "${Audiences}" ]${ExtraClaims}
                                  },
                                  "StringLike": {
                                      "${OidcProviderIssuer}:sub": [ "${Subjects}" ]
                                  }
                              }
                          }]
                      }
                    - Audiences:
                        Fn::Join:
                            - '","'
                            - Ref: OidcProviderAudiences
                      ExtraClaims:
                        Fn::If:
                            - OidcClaims
                            - Fn::Join:
                                - ""
                                - - ','
                                  - Fn::Join:
                                        - ','
                                        - Ref: OidcProviderClaims
                            - ""
                      Provider:
                        Ref: OIDCProvider
                      Subjects:
                        Fn::Join:
                            - '","'
                            - Ref: OidcProviderSubjects
            ManagedPolicyArns:
                - arn:aws:iam::aws:policy/AdministratorAccess
            RoleName:
                Fn::If:
                    - OverrideCIRoleName
                    - Ref: CIRoleName
                    - Ref: AWS::NoValue
            Tags:
                - Key: defang:CreatedBy
                  Value: defang
                - Key: defang:Prefix
                  Value: test
                - Key: defang:ManagedBy
                  Value: CloudFormation
                - Key: defang:CloudFormationStackName
                  Value:
                    Ref: AWS::StackName
                - Key: defang:CloudFormationStackRegion
                  Value:
                    Ref: AWS::Region
        Type: AWS::IAM::Role
    CapacityProvider:
        Properties:
            CapacityProviders:
                - FARGATE
                - FARGATE_SPOT
            Cluster:
                Ref: Cluster
            DefaultCapacityProviderStrategy:
                - CapacityProvider: FARGATE
                  Weight: 1
        Type: AWS::ECS::ClusterCapacityProviderAssociations
    Cluster:
        Properties:
            Tags:
                - Key: defang:CreatedBy
                  Value: defang
                - Key: defang:Prefix
                  Value: test
                - Key: defang:ManagedBy
                  Value: CloudFormation
                - Key: defang:CloudFormationStackName
                  Value:
                    Ref: AWS::StackName
                - Key: defang:CloudFormationStackRegion
                  Value:
                    Ref: AWS::Region
        Type: AWS::ECS::Cluster
    ExecutionRole:
        Properties:
            AssumeRolePolicyDocument:
                Statement:
                    - Action:
                        - sts:AssumeRole
                      Effect: Allow
                      Principal:
                        Service:
                            - ecs-tasks.amazonaws.com
                Version: "2012-10-17"
            ManagedPolicyArns:
                - arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy
            Policies:
                - PolicyDocument:
                    Statement:
                        - Action:
                            - ecr:CreatePullThroughCacheRule
                            - ecr:BatchImportUpstreamImage
                            - ecr:CreateRepository
                          Effect: Allow
                          Resource: '*'
                        - Fn::If:
                            - EnableDockerPullThroughCache
                            - Action:
                                - secretsmanager:GetSecretValue
                                - ssm:GetParameters
                              Effect: Allow
                              Resource:
                                Ref: PrivateRepoSecret
                            - Ref: AWS::NoValue
                    Version: "2012-10-17"
                  PolicyName: AllowECRPassThrough
            Tags:
                - Key: defang:CreatedBy
                  Value: defang
                - Key: defang:Prefix
                  Value: test
                - Key: defang:ManagedBy
                  Value: CloudFormation
                - Key: defang:CloudFormationStackName
                  Value:
                    Ref: AWS::StackName
                - Key: defang:CloudFormationStackRegion
                  Value:
                    Ref: AWS::Region
        Type: AWS::IAM::Role
    InternetGateway:
        Condition: CreateVpcResources
        Properties:
            Tags:
                - Key: Name
                  Value: test-igw
                - Key: defang:CreatedBy
                  Value: defang
                - Key: defang:Prefix
                  Value: test
                - Key: defang:ManagedBy
                  Value: CloudFormation
                - Key: defang:CloudFormationStackName
                  Value:
                    Ref: AWS::StackName
                - Key: defang:CloudFormationStackRegion
                  Value:
                    Ref: AWS::Region
        Type: AWS::EC2::InternetGateway
    InternetGatewayAttachment:
        Condition: CreateVpcResources
        Properties:
            InternetGatewayId:
                Ref: InternetGateway
            VpcId:
                Ref: VPC
        Type: AWS::EC2::VPCGatewayAttachment
    LogGroup:
        DependsOn:
            - Cluster
        Properties:
            RetentionInDays: 1
            Tags:
                - Key: defang:CreatedBy
                  Value: defang
                - Key: defang:Prefix
                  Value: test
                - Key: defang:ManagedBy
                  Value: CloudFormation
                - Key: defang:CloudFormationStackName
                  Value:
                    Ref: AWS::StackName
                - Key: defang:CloudFormationStackRegion
                  Value:
                    Ref: AWS::Region
        Type: AWS::Logs::LogGroup
    OIDCProvider:
        Condition: OidcProvider
        Properties:
            ClientIdList:
                Ref: OidcProviderAudiences
            Tags:
                - Key: defang:CreatedBy
                  Value: defang
                - Key: defang:Prefix
                  Value: test
                - Key: defang:ManagedBy
                  Value: CloudFormation
                - Key: defang:CloudFormationStackName
                  Value:
                    Ref: AWS::StackName
                - Key: defang:CloudFormationStackRegion
                  Value:
                    Ref: AWS::Region
            ThumbprintList:
                Fn::If:
                    - OidcThumbprints
                    - Ref: OidcProviderThumbprints
                    - Ref: AWS::NoValue
            Url:
                Fn::Sub: https://${OidcProviderIssuer}
        Type: AWS::IAM::OIDCProvider
    PrivateRepoSecret:
        Condition: EnableDockerPullThroughCache
        Properties:
            Description: Docker Hub credentials for the ECR pull-through cache rule
            Name: ecr-pullthroughcache/test-docker-public
            SecretString:
                Fn::Sub: '{"username":"${DockerHubUsername}","accessToken":"${DockerHubAccessToken}"}'
            Tags:
                - Key: defang:CreatedBy
                  Value: defang
                - Key: defang:Prefix
                  Value: test
                - Key: defang:ManagedBy
                  Value: CloudFormation
                - Key: defang:CloudFormationStackName
                  Value:
                    Ref: AWS::StackName
                - Key: defang:CloudFormationStackRegion
                  Value:
                    Ref: AWS::Region
        Type: AWS::SecretsManager::Secret
    PullThroughCache:
        Condition: EnablePullThroughCache
        Properties:
            EcrRepositoryPrefix: test-ecr-public
            UpstreamRegistryUrl: public.ecr.aws
        Type: AWS::ECR::PullThroughCacheRule
    PullThroughCacheDocker:
        Condition: EnableDockerPullThroughCache
        Properties:
            CredentialArn:
                Ref: PrivateRepoSecret
            EcrRepositoryPrefix: test-docker-public
            UpstreamRegistryUrl: registry-1.docker.io
        Type: AWS::ECR::PullThroughCacheRule
    Route:
        Condition: CreateVpcResources
        Properties:
            DestinationCidrBlock: 0.0.0.0/0
            GatewayId:
                Ref: InternetGateway
            RouteTableId:
                Ref: RouteTable
        Type: AWS::EC2::Route
    RouteTable:
        Condition: CreateVpcResources
        Properties:
            Tags:
                - Key: Name
                  Value: test-routetable
                - Key: defang:CreatedBy
                  Value: defang
                - Key: defang:Prefix
                  Value: test
                - Key: defang:ManagedBy
                  Value: CloudFormation
                - Key: defang:CloudFormationStackName
                  Value:
                    Ref: AWS::StackName
                - Key: defang:CloudFormationStackRegion
                  Value:
                    Ref: AWS::Region
            VpcId:
                Ref: VPC
        Type: AWS::EC2::RouteTable
    S3GatewayEndpoint:
        Condition: CreateVpcResources
        Properties:
            ServiceName:
                Fn::Sub: com.amazonaws.${AWS::Region}.s3
            VpcEndpointType: Gateway
            VpcId:
                Ref: VPC
        Type: AWS::EC2::VPCEndpoint
    SecurityGroup:
        Properties:
            GroupDescription: Security group for the ECS task that allows all outbound traffic
            Tags:
                - Key: defang:CreatedBy
                  Value: defang
                - Key: defang:Prefix
                  Value: test
                - Key: defang:ManagedBy
                  Value: CloudFormation
                - Key: defang:CloudFormationStackName
                  Value:
                    Ref: AWS::StackName
                - Key: defang:CloudFormationStackRegion
                  Value:
                    Ref: AWS::Region
            VpcId:
                Fn::If:
                    - CreateVpcResources
                    - Ref: VPC
                    - Ref: ExistingVpcId
        Type: AWS::EC2::SecurityGroup
    Subnet:
        Condition: CreateVpcResources
        Properties:
            CidrBlock: 10.0.0.0/20
            MapPublicIpOnLaunch: true
            Tags:
                - Key: Name
                  Value: test-subnet
                - Key: defang:CreatedBy
                  Value: defang
                - Key: defang:Prefix
                  Value: test
                - Key: defang:ManagedBy
                  Value: CloudFormation
                - Key: defang:CloudFormationStackName
                  Value:
                    Ref: AWS::StackName
                - Key: defang:CloudFormationStackRegion
                  Value:
                    Ref: AWS::Region
            VpcId:
                Ref: VPC
        Type: AWS::EC2::Subnet
    SubnetRouteTableAssociation:
        Condition: CreateVpcResources
        Properties:
            RouteTableId:
                Ref: RouteTable
            SubnetId:
                Ref: Subnet
        Type: AWS::EC2::SubnetRouteTableAssociation
    TaskDefinition:
        Properties:
            ContainerDefinitions:
                - Image: alpine:latest
                  LogConfiguration:
                    LogDriver: awslogs
                    Options:
                        awslogs-group:
                            Ref: LogGroup
                        awslogs-region:
                            Ref: AWS::Region
                        awslogs-stream-prefix: defang
                  Name: main
                  StopTimeout: 120
                - Image:
                    Fn::If:
                        - EnableDockerPullThroughCache
                        - Fn::Sub: ${AWS::AccountId}.dkr.ecr.${AWS::Region}.amazonaws.com/test-docker-public/library/alpine:latest
                        - docker.io/library/alpine:latest
                  LogConfiguration:
                    LogDriver: awslogs
                    Options:
                        awslogs-group:
                            Ref: LogGroup
                        awslogs-region:
                            Ref: AWS::Region
                        awslogs-stream-prefix: defang
                  Name: main2
                  StopTimeout: 120
                - Image:
                    Fn::If:
                        - EnablePullThroughCache
                        - Fn::Sub: ${AWS::AccountId}.dkr.ecr.${AWS::Region}.amazonaws.com/test-ecr-public/docker/library/alpine:latest
                        - public.ecr.aws/docker/library/alpine:latest
                  LogConfiguration:
                    LogDriver: awslogs
                    Options:
                        awslogs-group:
                            Ref: LogGroup
                        awslogs-region:
                            Ref: AWS::Region
                        awslogs-stream-prefix: defang
                  Name: main3
                  StopTimeout: 120
            Cpu: "256"
            ExecutionRoleArn:
                Ref: ExecutionRole
            Memory: "512"
            NetworkMode: awsvpc
            RequiresCompatibilities:
                - FARGATE
            RuntimePlatform:
                CpuArchitecture: X86_64
                OperatingSystemFamily: LINUX
            Tags:
                - Key: defang:CreatedBy
                  Value: defang
                - Key: defang:Prefix
                  Value: test
                - Key: defang:ManagedBy
                  Value: CloudFormation
                - Key: defang:CloudFormationStackName
                  Value:
                    Ref: AWS::StackName
                - Key: defang:CloudFormationStackRegion
                  Value:
                    Ref: AWS::Region
            TaskRoleArn:
                Ref: TaskRole
        Type: AWS::ECS::TaskDefinition
    TaskRole:
        Properties:
            AssumeRolePolicyDocument:
                Statement:
                    - Action:
                        - sts:AssumeRole
                      Effect: Allow
                      Principal:
                        Service:
                            - ecs-tasks.amazonaws.com
                Version: "2012-10-17"
            ManagedPolicyArns:
                - arn:aws:iam::aws:policy/AdministratorAccess
            Policies:
                - PolicyDocument:
                    Statement:
                        - Action:
                            - ssmmessages:CreateDataChannel
                            - ssmmessages:OpenDataChannel
                            - ssmmessages:OpenControlChannel
                            - ssmmessages:CreateControlChannel
                          Effect: Allow
                          Resource: '*'
                    Version: "2012-10-17"
                  PolicyName: AllowExecuteCommand
                - PolicyDocument:
                    Statement:
                        - Action:
                            - iam:PassRole
                          Effect: Allow
                          Resource: '*'
                    Version: "2012-10-17"
                  PolicyName: AllowPassRole
                - PolicyDocument:
                    Statement:
                        - Action:
                            - sts:AssumeRole
                          Effect: Allow
                          Resource: '*'
                    Version: "2012-10-17"
                  PolicyName: AllowAssumeRole
            Tags:
                - Key: defang:CreatedBy
                  Value: defang
                - Key: defang:Prefix
                  Value: test
                - Key: defang:ManagedBy
                  Value: CloudFormation
                - Key: defang:CloudFormationStackName
                  Value:
                    Ref: AWS::StackName
                - Key: defang:CloudFormationStackRegion
                  Value:
                    Ref: AWS::Region
        Type: AWS::IAM::Role
    VPC:
        Condition: CreateVpcResources
        Properties:
            CidrBlock: 10.0.0.0/16
            Tags:
                - Key: Name
                  Value: test-vpc
                - Key: defang:CreatedBy
                  Value: defang
                - Key: defang:Prefix
                  Value: test
                - Key: defang:ManagedBy
                  Value: CloudFormation
                - Key: defang:CloudFormationStackName
                  Value:
                    Ref: AWS::StackName
                - Key: defang:CloudFormationStackRegion
                  Value:
                    Ref: AWS::Region
        Type: AWS::EC2::VPC
